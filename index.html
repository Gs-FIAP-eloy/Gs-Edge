<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EloyBand — Dashboard MQTT</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto;
      margin: 12px;
      background: #0d1117;
      color: #e6edf3;
    }
    header {
      display:flex;
      justify-content:space-between;
      margin-bottom:12px;
    }
    h1 {
      font-size:20px;
      margin:0;
      color:#fff;
    }

    .card {
      background:#161b22;
      border-radius:10px;
      padding:12px;
      border:1px solid #30363d;
    }

    input {
      background:#0d1117;
      border:1px solid #30363d;
      color:#e6edf3;
      border-radius:8px;
      padding:8px;
      width:100%;
    }

    button {
      background:#2385f4;
      border:0;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      color:white;
      margin-top:10px;
      width:100%;
    }

    #log {
      background:#0a0f16;
      border:1px solid #30363d;
      max-height:260px;
      overflow:auto;
      padding:8px;
      font-family:monospace;
    }

    .metric {
      background:#0f141a;
      border-radius:8px;
      padding:10px;
      border:1px solid #30363d;
      margin-bottom:10px;
    }

    .grid {
      display:grid;
      grid-template-columns: 380px 1fr;
      gap:14px;
    }

    #alerts {
      background:#121820;
      padding:10px;
      border-radius:8px;
      border:1px solid #30363d;
      max-height:140px;
      overflow-y:auto;
    }

    canvas {
      background:#0f141a;
      border-radius:10px;
      padding:10px;
      border:1px solid #30363d;
    }
  </style>
</head>

<body>

  <header>
    <h1>EloyBand — Dashboard</h1>
    <small>MQTT Monitor</small>
  </header>

  <div class="grid">
    <!-- Painel esquerdo -->
    <div>
      <div class="card">
        <h3>Configuração MQTT</h3>
        <label>Broker:</label>
        <input id="broker" value="wss://broker.emqx.io:8084/mqtt">

        <label style="margin-top:10px;">Tópico Dados:</label>
        <input id="topicData" value="eloy/band01/data">

        <label style="margin-top:10px;">Tópico Alertas:</label>
        <input id="topicAlert" value="eloy/band01/alerts">

        <button onclick="conectar()">Conectar</button>
      </div>

      <br>

      <div class="metric">
        <h3>Heart Rate</h3>
        <div id="m_hr">--</div>
      </div>

      <div class="metric">
        <h3>Distância (cm)</h3>
        <div id="m_dist">--</div>
      </div>

      <div class="metric">
        <h3>Modo</h3>
        <div id="m_mode">--</div>
      </div>

      <div class="metric">
        <h3>Total de Mensagens Recebidas</h3>
        <div id="m_count">0</div>
      </div>

      <div class="card">
        <h3>Log</h3>
        <div id="log"></div>
      </div>
    </div>

    <!-- Painel direito -->
    <div>
      <div class="card">
        <h3>Gráfico de Tempo por Modo</h3>
        <canvas id="modeChart" width="300" height="300"></canvas>
      </div>

      <br>

      <div class="card">
        <h3>Alertas</h3>
        <div id="alerts"></div>
      </div>
    </div>
  </div>

  <script>
    let client = null;
    let msgCount = 0;

    // tempo acumulado por modo
    const modeTime = {
      WorkOFF: 0,
      WorkON: 0,
      Working: 0
    };

    let lastMode = null;
    let lastTimestamp = null;

    function log(msg) {
      const logBox = document.getElementById("log");
      logBox.innerHTML += msg + "<br>";
      logBox.scrollTop = logBox.scrollHeight;
    }

    // Chart.js — gráfico de rosca
    const ctx = document.getElementById("modeChart").getContext("2d");
    const modeChart = new Chart(ctx, {
      type: "doughnut",
      data: {
        labels: ["WorkOFF", "WorkON", "Working"],
        datasets: [{
          data: [0, 0, 0],
          backgroundColor: ["#374151", "#1d4ed8", "#059669"]
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color: "white" } } }
      }
    });

    function atualizarGrafico() {
      const total = modeTime.WorkOFF + modeTime.WorkON + modeTime.Working;
      if (total === 0) return;

      modeChart.data.datasets[0].data = [
        (modeTime.WorkOFF / total) * 100,
        (modeTime.WorkON / total) * 100,
        (modeTime.Working / total) * 100
      ];
      modeChart.update();
    }

    function conectar() {
      const broker = document.getElementById("broker").value;
      const topicData = document.getElementById("topicData").value;
      const topicAlert = document.getElementById("topicAlert").value;

      log("Conectando ao broker...");

      client = mqtt.connect(broker);

      client.on("connect", () => {
        log("Conectado com sucesso!");
        client.subscribe(topicData);
        client.subscribe(topicAlert);
      });

      client.on("message", (topic, payload) => {
        const msg = payload.toString();
        msgCount++;
        document.getElementById("m_count").innerText = msgCount;

        if (topic === topicAlert) {
          const a = document.getElementById("alerts");
          a.innerHTML += `<div style='color:#ff5555'>${msg}</div>`;
          return;
        }

        try {
          const data = JSON.parse(msg);

          document.getElementById("m_hr").innerText = data.heart_rate;
          document.getElementById("m_dist").innerText = data.distance_cm;
          document.getElementById("m_mode").innerText = data.mode;

          // cálculo de tempo
          const now = Date.now();
          if (lastTimestamp && lastMode) {
            modeTime[lastMode] += (now - lastTimestamp);
            atualizarGrafico();
          }

          lastMode = data.mode;
          lastTimestamp = now;

        } catch (e) {
          log("Erro ao parsear JSON");
        }
      });
    }
  </script>
</body>
</html>
