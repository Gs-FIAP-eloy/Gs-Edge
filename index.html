<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta viewport="width=device-width,initial-scale=1" />
  <title>EloyBand — Dashboard MQTT</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    body {
      font-family: Inter, system-ui;
      margin: 0;
      background: #0d1117;
      color: #e6edf3;
      overflow: hidden;
    }
    header {
      padding: 10px 18px;
      background: #0f141a;
      border-bottom: 1px solid #30363d;
    }
    .layout {
      display: grid;
      grid-template-columns: 330px 1fr;
      grid-template-rows: 300px 1fr;
      gap: 12px;
      height: calc(100vh - 55px);
      padding: 12px;
      box-sizing: border-box;
    }
    .card {
      background: #161b22;
      border-radius: 10px;
      padding: 12px;
      border: 1px solid #30363d;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* Container do gráfico reduzido */
    #chartWrapper {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    #doughnutChart {
      max-width: 80%;
      max-height: 80%;
    }

    /* Status */
    #status {
      font-weight: bold;
      margin-top: 6px;
    }

    /* Log */
    #log { display:none; }
    .log-title {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #log {
      background: #0a0f16;
      border: 1px solid #30363d;
      height: 100%;
      overflow-y: auto;
      padding: 6px;
      font-family: monospace;
      font-size: 12px;
    }

    input, button {
      margin-bottom: 6px;
      padding: 7px;
      border-radius: 6px;
      border: 1px solid #30363d;
      background: #0d1117;
      color: #e6edf3;
    }
    button { background: #2385f4; cursor:pointer; }
    .toggle-btn { padding: 3px 7px; font-size: 11px; }

    /* Toast */
    #toastArea {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 9999;
    }
    .toast {
      background: #14314a;
      padding: 12px 16px;
      border-left: 4px solid #1f6feb;
      border-radius: 8px;
      opacity: 0;
      transform: translateX(40px);
      animation: toastIn .35s forwards, toastOut .35s 4.5s forwards;
    }
    @keyframes toastIn { to { opacity:1; transform:translateX(0); } }
    @keyframes toastOut { to { opacity:0; transform:translateX(40px); } }

    /* Indicadores em linha */
    .metrics-row {
      display: flex;
      gap: 10px;
      margin-top: 8px;
    }
    .metric {
      background: #0d1117;
      border: 1px solid #30363d;
      border-radius: 6px;
      padding: 8px;
      flex:1;
      text-align:center;
    }
  </style>
</head>

<body>

<header><h1>EloyBand — Dashboard MQTT</h1></header>

<div id="toastArea"></div>

<div class="layout">

  <!-- CONEXÃO -->
  <div class="card">
    <h2>Conexão MQTT</h2>
    <input id="broker" value="wss://broker.emqx.io:8084/mqtt">
    <input id="topicData" value="eloy/band01/data">
    <input id="topicAlert" value="eloy/band01/alerts">
    <button onclick="connectMQTT()">Conectar</button>
    <div id="status">Status = Desconectado</div>
  </div>

  <!-- GRÁFICO -->
  <div class="card">
    <h2>Modos de Trabalho</h2>
    <div id="chartWrapper">
      <canvas id="doughnutChart"></canvas>
    </div>
  </div>

  <!-- LOG -->
  <div class="card">
    <div class="log-title">
      <h2>Log</h2>
      <button class="toggle-btn" onclick="toggleLog()">Mostrar</button>
    </div>
    <div id="log"></div>
  </div>

  <!-- INDICADORES -->
  <div class="card">
    <h2>Indicadores</h2>

    <div class="metrics-row">
      <div class="metric">HR: <span id="hr">--</span></div>
      <div class="metric">Dist: <span id="dist">--</span> cm</div>
      <div class="metric">Modo: <span id="mode">--</span></div>
    </div>
  </div>

</div>

<script>
let client;
let showLog = false;

function toggleLog(){
  showLog = !showLog;
  document.getElementById("log").style.display = showLog ? "block":"none";
  document.querySelector(".toggle-btn").innerText = showLog ? "Esconder":"Mostrar";
}

/* Plugin para desenhar porcentagens */
const percentPlugin = {
  id: "percentPlugin",
  afterDraw(chart) {
    const ctx = chart.ctx;
    const dataset = chart.data.datasets[0];
    const meta = chart.getDatasetMeta(0);
    const total = dataset.data.reduce((a,b)=>a+b,0);

    ctx.fillStyle = "#fff";
    ctx.font = "bold 13px Inter";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    meta.data.forEach((slice, i) => {
      const value = dataset.data[i];
      if(value === 0) return;

      const pct = ((value / total) * 100).toFixed(1) + "%";

      const pos = slice.tooltipPosition();
      ctx.fillText(pct, pos.x, pos.y);
    });
  }
};

/* Gráfico */
const ctx = document.getElementById("doughnutChart");
const chart = new Chart(ctx, {
  type: "doughnut",
  plugins: [percentPlugin],
  data: {
    labels: ["WorkOFF", "WorkON", "Working"],
    datasets: [{
      data: [0,0,0],
      backgroundColor: ["#d92b2b","#2385f4","#a445f7"],
      borderWidth: 0
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    cutout: "55%",
    radius: "85%"
  }
});

function connectMQTT(){
  const broker = document.getElementById("broker").value;
  const topicData = document.getElementById("topicData").value;
  const topicAlert = document.getElementById("topicAlert").value;

  client = mqtt.connect(broker);

  client.on("connect",()=>{
    document.getElementById("status").innerText = "Status = Conectado";
    client.subscribe(topicData);
    client.subscribe(topicAlert);
  });

  client.on("message",(topic,msg)=>{
    const m = msg.toString();
    addLog("MQTT: " + m);

    if(topic === topicData) updateData(JSON.parse(m));
    if(topic === topicAlert) showToast(m);
  });

  client.on("close",()=>{
    document.getElementById("status").innerText = "Status = Desconectado";
  });
}

let counts = {WorkOFF:0, WorkON:0, Working:0};

function updateData(d){
  document.getElementById("hr").innerText = d.heart_rate;
  document.getElementById("dist").innerText = d.distance_cm;
  document.getElementById("mode").innerText = d.mode;

  counts[d.mode]++;

  chart.data.datasets[0].data = [
    counts.WorkOFF,
    counts.WorkON,
    counts.Working
  ];
  chart.update();
}

function addLog(msg){
  const log = document.getElementById("log");
  log.innerHTML += msg + "<br>";
  log.scrollTop = log.scrollHeight;
}

function showToast(msg){
  const area = document.getElementById("toastArea");
  const t = document.createElement("div");
  t.className = "toast";
  t.innerText = msg;
  area.appendChild(t);
  setTimeout(()=>t.remove(),5200);
}
</script>

</body>
</html>
