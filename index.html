<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EloyBand â€” Dashboard MQTT</title>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto;
      margin: 0;
      background: #0d1117;
      color: #e6edf3;
      overflow: hidden; /* Sem scroll */
    }

    header {
      padding: 14px 22px;
      background: #0f141a;
      border-bottom: 1px solid #30363d;
    }

    h1 {
      margin: 0;
      font-size: 23px;
      color: #fff;
    }

    /* GRID GERAL â€” CABE TUDO NA TELA */
    .layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      grid-template-rows: 350px 1fr;
      gap: 14px;
      height: calc(100vh - 70px);
      padding: 14px;
      box-sizing: border-box;
    }

    .card {
      background: #161b22;
      border-radius: 12px;
      padding: 14px;
      border: 1px solid #30363d;
      overflow: hidden;
    }

    /* Indicadores */
    .metric {
      padding: 10px;
      border-bottom: 1px solid #30363d;
      font-size: 16px;
    }

    .metric:last-child {
      border-bottom: none;
    }

    /* Log â†’ barra inferior esquerda */
    #log {
      background: #0a0f16;
      border: 1px solid #30363d;
      height: calc(100% - 10px);
      overflow-y: auto;
      padding: 8px;
      font-family: monospace;
      font-size: 13px;
    }

    /* Alertas â†’ painel inferior direito */
    #alerts {
      background: #0a0f16;
      border: 1px solid #30363d;
      height: calc(100% - 10px);
      overflow-y: auto;
      padding: 10px;
      font-size: 14px;
    }

    .alert {
      background: #14314a;
      padding: 8px;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 3px solid #1f6feb;
    }

    /* Inputs */
    input {
      margin-bottom: 6px;
      padding: 8px;
      width: 100%;
      border-radius: 6px;
      border: 1px solid #30363d;
      background: #0d1117;
      color: #e6edf3;
    }

    button {
      width: 100%;
      padding: 10px;
      background: #2385f4;
      color: white;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      margin-top: 4px;
    }

  </style>
</head>

<body>

<header>
  <h1>EloyBand â€” Dashboard MQTT</h1>
</header>

<div class="layout">

  <!-- ðŸŸ¦ COLUNA ESQUERDA SUPERIOR â€” ConexÃ£o + Indicadores -->
  <div class="card">
    <h2 style="margin:0 0 8px 0;">ConexÃ£o MQTT</h2>

    <input id="broker" value="wss://broker.emqx.io:8084/mqtt">
    <input id="topicData" value="eloy/band01/data">
    <input id="topicAlert" value="eloy/band01/alerts">
    <button onclick="connectMQTT()">Conectar</button>

    <h3>Status</h3>
    <div id="status">Desconectado</div>

    <h3 style="margin-top:14px;">Indicadores</h3>
    <div class="metric">Heart Rate: <span id="hr">--</span></div>
    <div class="metric">DistÃ¢ncia: <span id="dist">--</span> cm</div>
    <div class="metric">Modo: <span id="mode">--</span></div>
  </div>

  <!-- ðŸŸ¦ CENTRO SUPERIOR â€” GrÃ¡fico Donut -->
  <div class="card">
    <h2 style="margin:0 0 8px 0;">Modos de Trabalho</h2>
    <canvas id="doughnutChart"></canvas>
  </div>

  <!-- ðŸŸ¦ INFERIOR ESQUERDA â€” LOG -->
  <div class="card">
    <h2 style="margin:0 0 8px 0;">Log</h2>
    <div id="log"></div>
  </div>

  <!-- ðŸŸ¦ INFERIOR DIREITA â€” ALERTAS -->
  <div class="card">
    <h2 style="margin:0 0 8px 0;">Alertas</h2>
    <div id="alerts"></div>
  </div>

</div>

<script>
let client;
let counts = { WorkOFF: 0, WorkON: 0, Working: 0 };

const ctx = document.getElementById("doughnutChart");
const chart = new Chart(ctx, {
  type: "doughnut",
  data: {
    labels: ["WorkOFF", "WorkON", "Working"],
    datasets: [{
      data: [0, 0, 0],
      backgroundColor: ["#444", "#1f6feb", "#2ea043"],
      borderWidth: 0
    }]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false
  }
});

function connectMQTT() {
  const broker = document.getElementById("broker").value;
  const topicData = document.getElementById("topicData").value;
  const topicAlert = document.getElementById("topicAlert").value;

  client = mqtt.connect(broker);

  client.on("connect", () => {
    document.getElementById("status").innerText = "Conectado";
    client.subscribe(topicData);
    client.subscribe(topicAlert);
  });

  client.on("message", (topic, msg) => {
    const text = msg.toString();
    addLog("MQTT RECEBIDO: " + text);

    if (topic === topicData) updateData(JSON.parse(text));
    if (topic === topicAlert) addAlert(text);
  });
}

function updateData(data) {
  document.getElementById("hr").innerText = data.heart_rate;
  document.getElementById("dist").innerText = data.distance_cm;
  document.getElementById("mode").innerText = data.mode;

  counts[data.mode]++;
  chart.data.datasets[0].data = [
    counts.WorkOFF,
    counts.WorkON,
    counts.Working
  ];
  chart.update();
}

function addLog(msg) {
  const log = document.getElementById("log");
  log.innerHTML += msg + "<br>";
  log.scrollTop = log.scrollHeight;
}

function addAlert(msg) {
  const box = document.getElementById("alerts");
  const div = document.createElement("div");
  div.className = "alert";
  div.innerText = msg;
  box.prepend(div);
}
</script>

</body>
</html>
