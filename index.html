<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EloyBand — Dashboard MQTT</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>

  <style>
    body {
      font-family: Inter, system-ui;
      margin: 0;
      background: #000;
      color: #fff;
      overflow: hidden;
    }

    header {
      padding: 14px 22px;
      background: #0a0a0a;
      border-bottom: 1px solid #1a1a1a;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }

    h1 { margin:0; font-size:23px; color:#fff; }

    /* Layout */
    .layout {
      display: grid;
      grid-template-columns: 380px 1fr;
      grid-template-rows: 350px 1fr;
      gap: 14px;
      height: calc(100vh - 70px);
      padding: 14px;
      box-sizing: border-box;
    }

    .card {
      background: #0a0a0a;
      border-radius: 10px;
      padding: 14px;
      border: 1px solid #1a1a1a;
      overflow: hidden;
    }

    .metric {
      padding: 10px 0;
      border-bottom: 1px solid #1a1a1a;
      font-size: 16px;
    }
    .metric:last-child { border-bottom: none; }

    #log {
      background: #000;
      border: 1px solid #1a1a1a;
      height: calc(100% - 10px);
      overflow-y: auto;
      padding: 8px;
      font-family: monospace;
      font-size: 13px;
      display:none;
    }

    #alerts { background:#000; border:1px solid #1a1a1a; height:calc(100% - 10px); overflow-y:auto; padding:10px; }
    .alert { background:#111; padding:8px; border-radius:6px; margin-bottom:8px; border-left:3px solid #2385f4; }

    input, button { width:100%; padding:10px; margin-top:6px; border-radius:6px; }

    input {
      background:#000;
      border:1px solid #1a1a1a;
      color:#fff;
    }

    button {
      background:#2385f4;
      color:white;
      border:none;
      cursor:pointer;
    }

    #toggleLogBtn {
      width:auto;
      padding:8px 12px;
      font-size:14px;
    }

    /* Reduz a rosca */
    #doughnutChart { max-height: 72% !important; }
  </style>
</head>

<body>

<header>
  <h1>EloyBand — Dashboard MQTT</h1>
  <button id="toggleLogBtn">Mostrar Log</button>
</header>

<div class="layout">

  <!-- Esquerda Superior -->
  <div class="card">
    <h2 style="margin:0 0 8px 0;">Conexão MQTT</h2>

    <input id="broker" value="wss://broker.emqx.io:8084/mqtt">
    <input id="topicData" value="eloy/band01/data">
    <input id="topicAlert" value="eloy/band01/alerts">
    <button onclick="connectMQTT()">Conectar</button>

    <h3>Status</h3>
    <div id="status">Desconectado</div>

    <h3 style="margin-top:14px;">Indicadores</h3>
    <div class="metric">Heart Rate: <span id="hr">--</span></div>
    <div class="metric">Distância: <span id="dist">--</span> cm</div>
    <div class="metric">Modo: <span id="mode">--</span></div>
  </div>

  <!-- Centro Superior -->
  <div class="card">
    <h2 style="margin:0 0 8px 0;">Modos de Trabalho</h2>
    <canvas id="doughnutChart"></canvas>
  </div>

  <!-- Inferior Esquerda -->
  <div class="card">
    <h2 style="margin:0 0 8px 0;">Log</h2>
    <div id="log"></div>
  </div>

  <!-- Inferior Direita -->
  <div class="card">
    <h2 style="margin:0 0 8px 0;">Alertas</h2>
    <div id="alerts"></div>
  </div>

</div>

<script>
let client;
let counts = { WorkOFF: 0, WorkON: 0, Working: 0 };

// Chart
const ctx = document.getElementById("doughnutChart");
const chart = new Chart(ctx, {
  type: "doughnut",
  data: {
    labels: ["WorkOFF", "WorkON", "Working"],
    datasets: [{
      data: [0, 0, 0],
      backgroundColor: ["#1f6feb", "#8b00ff", "#ff0033"],
      borderWidth: 0
    }]
  },
  options: { responsive: true, maintainAspectRatio: false }
});

// MQTT
function connectMQTT() {
  const broker = document.getElementById("broker").value;
  const topicData = document.getElementById("topicData").value;
  const topicAlert = document.getElementById("topicAlert").value;

  client = mqtt.connect(broker);

  client.on("connect", () => {
    document.getElementById("status").innerText = "Conectado";
    client.subscribe(topicData);
    client.subscribe(topicAlert);
  });

  client.on("message", (topic, msg) => {
    const text = msg.toString();
    addLog("MQTT RECEBIDO: " + text);

    if (topic === topicData) updateData(JSON.parse(text));
    if (topic === topicAlert) addAlert(text);
  });
}

function updateData(data) {
  document.getElementById("hr").innerText = data.heart_rate;
  document.getElementById("dist").innerText = data.distance_cm;
  document.getElementById("mode").innerText = data.mode;

  counts[data.mode]++;
  chart.data.datasets[0].data = [counts.WorkOFF, counts.WorkON, counts.Working];
  chart.update();
}

// Log
const logEl = document.getElementById("log");
const toggleBtn = document.getElementById("toggleLogBtn");

toggleBtn.onclick = () => {
  if (logEl.style.display === "none") {
    logEl.style.display = "block";
    toggleBtn.textContent = "Ocultar Log";
  } else {
    logEl.style.display = "none";
    toggleBtn.textContent = "Mostrar Log";
  }
};

function addLog(msg) {
  logEl.innerHTML += msg + "<br>";
  logEl.scrollTop = logEl.scrollHeight;
}

// Alertas
function addAlert(msg) {
  const box = document.getElementById("alerts");
  const div = document.createElement("div");
  div.className = "alert";
  div.innerText = msg;
  box.prepend(div);
}
</script>

</body>
</html>